<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced CMS Dashboard</title>
    <style>
        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fff9ed;
            color: #333;
            overflow-x: hidden;
        }

        /* Page System */
        .page {
            display: none;
            min-height: 100vh;
        }

        .page.active {
            display: block;
        }

        /* CMS Main Page Styles */
        #cms-page {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
        }

        h1 {
            color: #FF8C00;
            margin-bottom: 2rem;
        }

        .main-nav {
            background: linear-gradient(135deg, #FF8C00, #FFD700);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .nav-btn.css-editor {
            background: rgba(255, 255, 255, 0.9);
            color: #FF8C00;
            font-size: 1.1rem;
            padding: 1rem 2rem;
        }

        .nav-btn.css-editor:hover {
            background: white;
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* Status Messages */
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        /* CMS Panel */
        .cms-panel {
            margin: 18px 0 32px 0;
            background: #fff3e8;
            border-radius: 10px;
            border: 1px solid #ffdbaa;
            padding: 22px 16px 16px 16px;
        }

        .cms-panel label {
            font-weight: bold;
        }

        .cms-panel select {
            width: 260px;
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .cms-panel textarea {
            width: 98%;
            min-height: 186px;
            margin: 9px 0 12px 0;
            font-family: monospace;
            font-size: 15px;
            padding: 9px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        /* Menu Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        .editable-cell {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .editable-cell:hover {
            background-color: #f0f8ff;
        }

        .editable-cell input {
            width: 100%;
            border: none;
            background: transparent;
            padding: 4px;
            font-family: inherit;
            font-size: inherit;
        }

        .editable-cell textarea {
            width: 100%;
            border: none;
            background: transparent;
            padding: 4px;
            font-family: inherit;
            font-size: inherit;
            resize: vertical;
            min-height: 40px;
        }

        .save-cell {
            text-align: center;
        }

        .save-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: inline-block;
        }

        .save-btn:hover {
            background: #218838;
        }

        .formrow {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .formrow input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Image Grid */
        .imglist {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 18px;
            margin-bottom: 28px;
        }

        .imgcard {
            background: #fff;
            border: 1px solid #e1e5e9;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .imgcard img {
            max-width: 150px;
            max-height: 150px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .fname {
            font-family: monospace;
            color: #6c757d;
            font-size: 13px;
            margin-bottom: 8px;
            word-break: break-all;
        }

        .img-actions {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .img-actions button {
            margin: 0;
            padding: 4px 6px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
        }

        .img-actions .replace-btn {
            background: #17a2b8;
            color: white;
        }

        .img-actions .replace-btn:hover {
            background: #138496;
        }

        .img-actions .replace-existing-btn {
            background: #6f42c1;
            color: white;
        }

        .img-actions .replace-existing-btn:hover {
            background: #5a32a3;
        }

        .img-actions .delete-btn {
            background: #dc3545;
            color: white;
        }

        .img-actions .delete-btn:hover {
            background: #c82333;
        }

        .img-section-title {
            font-weight: bold;
            margin-top: 20px;
            font-size: 1.1em;
            color: #FF8C00;
            cursor: pointer;
            user-select: none;
        }

        .img-section-title:hover {
            color: #e67e00;
        }

        .img-section-content {
            display: block;
        }

        .img-section-content.collapsed {
            display: none;
        }

        .imglist-empty {
            color: #999;
            font-size: 1em;
            margin: 10px 0;
        }

        /* Image Selection Modal */
        .image-select-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .image-select-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .image-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 1rem;
        }

        .image-select-item {
            text-align: center;
            cursor: pointer;
            padding: 10px;
            border: 2px solid transparent;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .image-select-item:hover {
            border-color: #FF8C00;
            background: #fff9ed;
        }

        .image-select-item img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .image-select-item .image-name {
            font-size: 11px;
            color: #666;
            word-break: break-all;
        }

        /* CSS Editor Page Styles */
        #css-editor-page {
            display: flex;
            height: 100vh;
            background: #f5f5f5;
            color: #333;
            overflow: hidden;
        }

        /* Editor Sidebar */
        .editor-sidebar {
            width: 380px;
            background: linear-gradient(135deg, #FF8C00 0%, #FFD700 100%);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
        }

        .editor-header {
            padding: 2rem 1.5rem 1rem;
            color: white;
            text-align: center;
        }

        .editor-header h1 {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: white;
        }

        .editor-header p {
            font-size: 1rem;
            opacity: 0.9;
            line-height: 1.4;
        }

        .click-hint {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            padding: 1rem 1.5rem;
            text-align: center;
            font-size: 0.95rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .controls-area {
            flex: 1;
            background: white;
            overflow-y: auto;
            position: relative;
        }

        .welcome-message {
            padding: 3rem 2rem;
            text-align: center;
            color: #666;
        }

        .welcome-message .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .welcome-message h3 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: #333;
        }

        .welcome-message p {
            font-size: 1rem;
            line-height: 1.5;
            opacity: 0.8;
        }

        .element-info {
            background: #f8f9fa;
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .element-preview {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .element-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #FF8C00, #FFD700);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .element-details h3 {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 0.25rem;
        }

        .element-details p {
            font-size: 0.9rem;
            color: #666;
        }

        .css-selector-info {
            background: #fff3cd;
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            font-family: monospace;
            font-size: 0.8rem;
            color: #856404;
        }

        .controls-container {
            padding: 2rem;
        }

        .control-group {
            margin-bottom: 2rem;
        }

        .control-group h4 {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .control-item {
            margin-bottom: 1.5rem;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .control-label span:first-child {
            font-size: 1rem;
            color: #555;
            font-weight: 500;
        }

        .control-value {
            font-size: 0.9rem;
            color: #FF8C00;
            font-weight: 600;
            background: rgba(255, 140, 0, 0.1);
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            min-width: 60px;
            text-align: center;
        }

        .control-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e9ecef;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .control-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF8C00, #FFD700);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 10px rgba(255, 140, 0, 0.3);
            transition: all 0.2s ease;
        }

        .control-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(255, 140, 0, 0.5);
        }

        .save-changes-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 1rem;
            width: 100%;
            transition: all 0.2s ease;
        }

        .save-changes-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .edit-text-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 0.5rem 0;
        }

        .edit-text-btn:hover {
            background: #0056b3;
        }

        /* Preview Area */
        .editor-preview {
            flex: 1;
            background: #fff;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-preview-header {
            background: #f8f9fa;
            padding: 1rem 2rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .preview-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .reset-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .reset-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .iframe-container {
            flex: 1;
            position: relative;
            background: white;
        }

        .preview-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            display: block;
        }

        /* Login Modal */
        #token-prompt-modal {
            position: fixed;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.35);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        #token-prompt-box {
            background: #fff9ed;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            min-width: 300px;
            text-align: center;
        }

        #token-prompt-box h2 {
            margin-bottom: 1rem;
            color: #FF8C00;
        }

        #token-prompt-box input {
            width: 200px;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Button Styles */
        button {
            background: #FF8C00;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        button:hover {
            background: #e67e00;
        }

        /* Text Editor Modal */
        .text-editor-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .text-editor-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
        }

        .text-editor-content textarea {
            width: 100%;
            height: 200px;
            margin: 1rem 0;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }

        /* Image Upload Styles */
        .image-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .upload-btn, .replace-btn, .replace-existing-btn {
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .upload-btn {
            background: #28a745;
            color: white;
        }

        .upload-btn:hover {
            background: #218838;
        }

        .replace-btn {
            background: #17a2b8;
            color: white;
        }

        .replace-btn:hover {
            background: #138496;
        }

        .replace-existing-btn {
            background: #6f42c1;
            color: white;
        }

        .replace-existing-btn:hover {
            background: #5a32a3;
        }

        /* Responsive */
        @media (max-width: 768px) {
            #css-editor-page {
                flex-direction: column;
            }
            
            .editor-sidebar {
                width: 100%;
                height: 60vh;
            }
            
            .editor-preview {
                height: 40vh;
            }

            #cms-page {
                margin: 20px auto;
                padding: 15px;
            }

            .main-nav {
                flex-direction: column;
            }

            .formrow {
                flex-direction: column;
            }

            .image-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="token-prompt-modal">
        <div id="token-prompt-box">
            <h2>Admin Access</h2>
            <div>
                <label>Username/Email:</label><br>
                <input type="text" id="admin-username-input" placeholder="Username or Email" autofocus />
            </div>
            <div>
                <label>Password:</label><br>
                <input type="password" id="admin-token-input" placeholder="Admin Password" />
            </div>
            <button onclick="submitToken()">Login</button>
            <div id="login-error" class="error" style="margin-top:6px;"></div>
        </div>
    </div>

    <!-- Image Selection Modal -->
    <div id="imageSelectModal" class="image-select-modal">
        <div class="image-select-content">
            <h3>Select an Image to Replace With</h3>
            <div id="imageSelectGrid" class="image-select-grid"></div>
            <div style="margin-top: 1rem; text-align: right;">
                <button onclick="closeImageSelector()" style="background: #6c757d;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- CMS Main Page -->
    <div id="cms-page" class="page active">
        <button id="logout-btn" onclick="logout()" style="float:right; background: #888;">Logout</button>
        
        <h1>🎨 Advanced CMS Dashboard</h1>
        <div id="status"></div>

        <!-- Main Navigation -->
        <div class="main-nav">
            <button class="nav-btn css-editor" onclick="switchToEditor()">🎨 CSS Editor</button>
            <button class="nav-btn" onclick="scrollToSection('file-editor')">📝 File Editor</button>
            <button class="nav-btn" onclick="scrollToSection('images-section')">🖼️ Images</button>
            <button class="nav-btn" onclick="scrollToSection('menu-section')">🍽️ Menu</button>
        </div>

        <!-- File Editor Section -->
        <div id="file-editor" class="cms-panel">
            <label for="cms-filename-select">Edit Any File:</label>
            <select id="cms-filename-select"></select>
            <button onclick="loadFile()">Load</button>
            <span id="cms-status"></span>
            <textarea id="cms-content" spellcheck="false" placeholder="File contents (plain text)"></textarea>
            <div>
                <button onclick="saveFile()">Save/Publish</button>
                <span id="cms-save-status"></span>
            </div>
        </div>

        <!-- Images Section -->
        <div id="images-section">
            <h2>Images (NullPounce/SilentSetup/images)</h2>
            <button style="float:right" onclick="showImageUploader()">Upload Image</button>
            <input type="file" id="image-upload" accept="image/*" style="display:none">
            
            <div class="img-section-title" onclick="toggleImageSection('inuse')">
                ▼ Images in Use (linked from HTML/CSS/JS)
            </div>
            <div id="imglist-inuse-content" class="img-section-content">
                <div id="imglist-inuse" class="imglist"></div>
            </div>
            
            <div class="img-section-title" onclick="toggleImageSection('unused')">
                ▶ Unused Images (not referenced) <span style="font-size: 0.8em; color: #999;">(click to expand)</span>
            </div>
            <div id="imglist-unused-content" class="img-section-content collapsed">
                <div id="imglist-unused" class="imglist"></div>
            </div>
        </div>

        <!-- Menu Section -->
        <div id="menu-section">
            <h2>Add New Menu Item</h2>
            <form id="add-form">
                <div class="formrow">
                    <input required name="section" placeholder="Section (e.g. Grilled Cheese)" />
                    <input required name="title" placeholder="Title" />
                    <input required name="description" placeholder="Description" style="width: 220px;" />
                    <input required name="price" placeholder="Price (e.g. $8.99)" />
                    <input type="submit" value="Add Item">
                </div>
            </form>

            <h2>Menu Items (Click any cell to edit)</h2>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Section</th>
                        <th>Title</th>
                        <th>Description</th>
                        <th>Price</th>
                        <th>Save</th>
                        <th>Delete</th>
                    </tr>
                </thead>
                <tbody id="menu-table"></tbody>
            </table>
        </div>
    </div>

    <!-- CSS Editor Page -->
    <div id="css-editor-page" class="page">
        <!-- Editor Sidebar -->
        <aside class="editor-sidebar">
            <div class="editor-header">
                <h1>🎨 CSS Live Editor</h1>
                <p>Click any part of your website to customize it</p>
            </div>
            
            <div class="click-hint" id="clickHint">
                👆 Click anything in the preview to start editing
            </div>
            
            <div class="controls-area" id="controlsArea">
                <div class="welcome-message">
                    <div class="icon">🖱️</div>
                    <h3>Ready to customize!</h3>
                    <p>Click on any image, text, button, or section in your website preview to start editing its appearance.</p>
                </div>
            </div>
        </aside>

        <!-- Preview Area -->
        <section class="editor-preview">
            <div class="editor-preview-header">
                <span class="preview-title">📱 Your Website Preview</span>
                <button class="back-btn" onclick="backToCMS()">← Back to CMS</button>
                <button class="reset-btn" onclick="resetAllStyles()">🔄 Reset Everything</button>
            </div>
            <div class="iframe-container">
                <iframe id="previewFrame" class="preview-iframe"></iframe>
            </div>
        </section>
    </div>

    <!-- Text Editor Modal -->
    <div id="textEditorModal" class="text-editor-modal">
        <div class="text-editor-content">
            <h3>Edit Text Content</h3>
            <textarea id="textEditorTextarea" placeholder="Enter your text here..."></textarea>
            <div>
                <button onclick="saveTextEdit()">Save Text</button>
                <button onclick="closeTextEditor()" style="background: #6c757d;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ============= CONFIG =============
        const API_BASE = 'https://silent-setup-website-worker.nullpounce.workers.dev/';
        const GITHUB_USER = "NullPounce";
        const GITHUB_REPO = "SilentSetup";
        const IMAGES_FOLDER = "images";
        const GITHUB_REPOPATH = `${GITHUB_USER}/${GITHUB_REPO}`;

        // ========== GLOBAL STATE ==========
        let usernameToken = localStorage.getItem("usernameToken") || null;
        let adminToken = localStorage.getItem("adminToken") || null;
        let frameDocument = null;
        let frameWindow = null;
        let selectedElement = null;
        let originalStyles = new Map();
        let isFrameReady = false;
        let pendingChanges = {};
        let currentEditingElement = null;
        let cssContent = '';
        let menuData = {};
        let editedMenuItems = new Set();
        let allImages = [];
        let currentReplaceTarget = null;

        // ========== PAGE SWITCHING ==========
        function switchToEditor() {
            document.getElementById('cms-page').classList.remove('active');
            document.getElementById('css-editor-page').classList.add('active');
            setTimeout(() => {
                initializeEditor();
            }, 100);
        }

        function backToCMS() {
            document.getElementById('css-editor-page').classList.remove('active');
            document.getElementById('cms-page').classList.add('active');
        }

        function scrollToSection(sectionId) {
            document.getElementById(sectionId).scrollIntoView({ behavior: 'smooth' });
        }

        // ========== IMAGE SECTION TOGGLES ==========
        function toggleImageSection(section) {
            const content = document.getElementById(`imglist-${section}-content`);
            const title = content.previousElementSibling;
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                title.innerHTML = `▼ ${title.textContent.replace('▶', '').replace('(click to expand)', '').trim()}`;
            } else {
                content.classList.add('collapsed');
                const baseTitleText = title.textContent.replace('▼', '').replace('▶', '').trim();
                title.innerHTML = `▶ ${baseTitleText} <span style="font-size: 0.8em; color: #999;">(click to expand)</span>`;
            }
        }

        // ========== LOGIN LOGIC ==========
        function getTimestampedFilename(filename) {
            const ext = filename.split('.').pop();
            const base = filename.replace(/\.[^/.]+$/, "");
            const now = new Date();
            let mm = String(now.getMonth() + 1).padStart(2, '0');
            let dd = String(now.getDate()).padStart(2, '0');
            let yyyy = now.getFullYear();
            let h = now.getHours(), mer = 'AM';
            if (h >= 12) mer = 'PM';
            h = h % 12;
            if (h === 0) h = 12;
            let hh = String(h).padStart(2, '0');
            let min = String(now.getMinutes()).padStart(2, '0');
            const stamp = `${mm}-${dd}-${yyyy}_${hh}-${min}${mer}`;
            return `${base}_${stamp}.${ext}`;
        }

        function showTokenPrompt(error = "") {
            document.getElementById("token-prompt-modal").style.display = "flex";
            document.getElementById("admin-username-input").value = usernameToken || "";
            document.getElementById("admin-token-input").value = "";
            let errorMsg = document.getElementById("login-error");
            errorMsg.textContent = error ? error : "";
            setTimeout(() => document.getElementById("admin-username-input").focus(), 10);
        }

        function hideTokenPrompt() {
            document.getElementById("token-prompt-modal").style.display = "none";
        }

        async function validateTokens(uToken, aToken) {
            let resp = await fetch(API_BASE + "/menu/-1", {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "x-admin-token": aToken,
                    "x-username-token": uToken
                },
                body: JSON.stringify({ section: "_", title: "_", description: "_", price: "_" })
            });
            return resp.status !== 403;
        }

        async function submitToken() {
            const uToken = document.getElementById("admin-username-input").value.trim();
            const aToken = document.getElementById("admin-token-input").value;
            if (!uToken || !aToken) {
                document.getElementById("login-error").textContent = "Both fields required";
                return;
            }
            let ok = await validateTokens(uToken, aToken);
            if (ok) {
                usernameToken = uToken;
                adminToken = aToken;
                localStorage.setItem("usernameToken", uToken);
                localStorage.setItem("adminToken", aToken);
                hideTokenPrompt();
                await populateCmsDropdown();
                await fetchAndCategorizeImages();
                fetchMenu();
            } else {
                document.getElementById("login-error").textContent = "Wrong username or password.";
                usernameToken = null;
                adminToken = null;
                localStorage.removeItem("usernameToken");
                localStorage.removeItem("adminToken");
            }
        }

        function logout() {
            usernameToken = null;
            adminToken = null;
            localStorage.removeItem("usernameToken");
            localStorage.removeItem("adminToken");
            showTokenPrompt();
        }

        window.addEventListener("DOMContentLoaded", async () => {
            if (usernameToken && adminToken) {
                let ok = await validateTokens(usernameToken, adminToken);
                if (ok) {
                    hideTokenPrompt();
                    await populateCmsDropdown();
                    await fetchAndCategorizeImages();
                    fetchMenu();
                    return;
                } else {
                    usernameToken = null;
                    adminToken = null;
                    localStorage.removeItem("usernameToken");
                    localStorage.removeItem("adminToken");
                }
            }
            showTokenPrompt();
        });

        function setStatus(msg, type = "success") {
            document.getElementById("status").innerHTML = `<div class="${type}">${msg}</div>`;
            setTimeout(() => { document.getElementById("status").innerHTML = ""; }, 2800);
        }

        // ===== CMS FILE EDITOR LOGIC =====
        let lastFileSha = null;

        async function populateCmsDropdown() {
            const select = document.getElementById("cms-filename-select");
            select.innerHTML = '<option>Loading...</option>';
            const url = `https://api.github.com/repos/${GITHUB_REPOPATH}/contents/`;
            try {
                const resp = await fetch(url, { headers: { Accept: "application/vnd.github+json" } });
                if (!resp.ok) throw new Error("Bad response");
                const files = await resp.json();
                select.innerHTML = '';
                for (const file of files) {
                    if (file.type === 'file' && !file.name.startsWith('.')) {
                        select.innerHTML += `<option value="${file.name}">${file.name}</option>`;
                    }
                }
                if (!select.innerHTML) select.innerHTML = '<option>No files found</option>';
            } catch {
                select.innerHTML = '<option>Error loading files</option>';
            }
        }

        async function loadFile() {
            const filename = document.getElementById("cms-filename-select").value;
            if (!filename) return;
            document.getElementById("cms-content").value = "Loading...";
            document.getElementById("cms-status").textContent = "";
            lastFileSha = null;
            const url = `https://api.github.com/repos/${GITHUB_REPOPATH}/contents/${filename}?ref=main`;
            try {
                const resp = await fetch(url, { headers: { Accept: "application/vnd.github.v3.raw" } });
                if (resp.status === 200) {
                    const content = await resp.text();
                    document.getElementById("cms-content").value = content;
                    if (filename === 'style.css') {
                        cssContent = content;
                    }
                    const metaResp = await fetch(url.replace("?ref=main", ""), { headers: { Accept: "application/vnd.github+json" } });
                    if (metaResp.ok) {
                        const meta = await metaResp.json();
                        lastFileSha = meta.sha;
                    }
                    document.getElementById("cms-status").textContent = "Loaded ✔";
                } else {
                    document.getElementById("cms-content").value = "";
                    document.getElementById("cms-status").textContent = "Not found";
                }
            } catch {
                document.getElementById("cms-content").value = "";
                document.getElementById("cms-status").textContent = "Not found";
            }
        }

        async function saveFile() {
            const filename = document.getElementById("cms-filename-select").value;
            const content = document.getElementById("cms-content").value;
            if (!filename) return;
            document.getElementById("cms-save-status").textContent = "Publishing...";
            const resp = await fetch(API_BASE + "/github/edit-file", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-admin-token": adminToken,
                    "x-username-token": usernameToken
                },
                body: JSON.stringify({
                    repo: GITHUB_REPOPATH,
                    path: filename,
                    content: content,
                    message: `Edit ${filename} via dashboard`,
                    branch: "main",
                    sha: lastFileSha
                })
            });
            if (resp.ok) {
                document.getElementById("cms-save-status").textContent = "Published ✔";
                if (filename === 'style.css') {
                    cssContent = content;
                }
                loadFile();
            } else {
                try {
                    const err = await resp.json();
                    document.getElementById("cms-save-status").textContent = err.message || "Error publishing";
                } catch {
                    document.getElementById("cms-save-status").textContent = "Error publishing";
                }
            }
        }

        // ========== IMAGE MANAGEMENT ==========
        async function fetchRootHtmlCssJsFiles() {
            const url = `https://api.github.com/repos/${GITHUB_REPOPATH}/contents/`;
            const resp = await fetch(url, { headers: { Accept: "application/vnd.github+json" } });
            if (!resp.ok) return [];
            const files = await resp.json();
            return files.filter(f =>
                f.type === "file" &&
                (f.name.endsWith(".html") || f.name.endsWith(".css") || f.name.endsWith(".js"))
            ).map(f => f.name);
        }

        async function fetchTextFile(filename) {
            const url = `https://api.github.com/repos/${GITHUB_REPOPATH}/contents/${filename}?ref=main`;
            const resp = await fetch(url, { headers: { Accept: "application/vnd.github.v3.raw" } });
            if (resp.ok) return await resp.text();
            return "";
        }

        function findReferencedImages(allCode) {
            const regex = /images\/([a-zA-Z0-9._\-]+)/g;
            const found = new Set();
            for (let code of allCode) {
                let m;
                while ((m = regex.exec(code))) found.add(m[1]);
            }
            return found;
        }

        async function fetchAndCategorizeImages() {
            const inuseDiv = document.getElementById("imglist-inuse");
            const unusedDiv = document.getElementById("imglist-unused");
            inuseDiv.innerHTML = "<div>Loading images...</div>";
            unusedDiv.innerHTML = "";

            let imgs;
            try {
                const resp = await fetch(API_BASE + "/github/list-images", {
                    method: "POST",
                    headers: {
                        "x-admin-token": adminToken,
                        "x-username-token": usernameToken
                    },
                    cache: "no-store"
                });
                imgs = await resp.json();
                if (!resp.ok || !Array.isArray(imgs)) throw new Error("Error");
            } catch {
                inuseDiv.innerHTML = "<div class='error'>No images found / access denied.</div>";
                return;
            }

            // Store all images for the selector modal
            allImages = imgs;

            const files = await fetchRootHtmlCssJsFiles();
            let allCode = [];
            for (const f of files) {
                allCode.push(await fetchTextFile(f));
            }
            const referenced = findReferencedImages(allCode);

            let inUse = [], unused = [];
            for (const file of imgs) {
                if (referenced.has(file.name)) inUse.push(file);
                else unused.push(file);
            }

            inuseDiv.innerHTML = inUse.length ? "" : "<div class='imglist-empty'>None found.</div>";
            unusedDiv.innerHTML = unused.length ? "" : "<div class='imglist-empty'>None found.</div>";

            for (const file of inUse) {
                const card = document.createElement("div");
                card.className = "imgcard";
                card.innerHTML = `
                    <div class="fname">${file.name}</div>
                    <div style="height:152px;display:flex;align-items:center;justify-content:center">
                        <img loading="lazy" src="${file.display_url}" alt="${file.name}">
                    </div>
                    <div class="img-actions">
                        <button class="replace-btn" onclick="replaceImage('${file.name}','${file.sha}')">Replace</button>
                        <button class="replace-existing-btn" onclick="showReplaceWithExisting('${file.name}','${file.sha}')">Replace w/ Existing</button>
                        <button class="delete-btn" onclick="deleteImage('${file.name}','${file.sha}')">Delete</button>
                    </div>
                `;
                inuseDiv.appendChild(card);
                
                // Handle image load errors
                const imgel = card.querySelector("img");
                imgel.onerror = () => { 
                    imgel.style.display = "none"; 
                    card.querySelector(".fname").innerHTML += "<span style='color:red'>[Error loading]</span>"; 
                };
            }

            for (const file of unused) {
                const card = document.createElement("div");
                card.className = "imgcard";
                card.innerHTML = `
                    <div class="fname">${file.name}</div>
                    <div style="height:152px;display:flex;align-items:center;justify-content:center">
                        <img loading="lazy" src="${file.display_url}" alt="${file.name}">
                    </div>
                    <div class="img-actions">
                        <button class="replace-btn" onclick="replaceImage('${file.name}','${file.sha}')">Replace</button>
                        <button class="replace-existing-btn" onclick="showReplaceWithExisting('${file.name}','${file.sha}')">Replace w/ Existing</button>
                        <button class="delete-btn" onclick="deleteImage('${file.name}','${file.sha}')">Delete</button>
                    </div>
                `;
                unusedDiv.appendChild(card);
                
                // Handle image load errors  
                const imgel = card.querySelector("img");
                imgel.onerror = () => { 
                    imgel.style.display = "none"; 
                    card.querySelector(".fname").innerHTML += "<span style='color:red'>[Error loading]</span>"; 
                };
            }
        }

        // ========== REPLACE WITH EXISTING IMAGE LOGIC ==========
        function showReplaceWithExisting(targetImageName, targetImageSha) {
            currentReplaceTarget = { name: targetImageName, sha: targetImageSha };
            
            const modal = document.getElementById('imageSelectModal');
            const grid = document.getElementById('imageSelectGrid');
            
            // Clear previous content
            grid.innerHTML = '';
            
            // Populate with all images except the target
            allImages.forEach(img => {
                if (img.name !== targetImageName) {
                    const item = document.createElement('div');
                    item.className = 'image-select-item';
                    item.onclick = () => replaceWithSelectedImage(img.name);
                    
                    item.innerHTML = `
                        <img src="${img.display_url}" alt="${img.name}">
                        <div class="image-name">${img.name}</div>
                    `;
                    
                    grid.appendChild(item);
                }
            });
            
            modal.style.display = 'flex';
        }

        function closeImageSelector() {
            document.getElementById('imageSelectModal').style.display = 'none';
            currentReplaceTarget = null;
        }

        // Updates HTML/CSS references instead of overwriting image content
        async function replaceWithSelectedImage(sourceImageName) {
            if (!currentReplaceTarget) return;
            
            const targetName = currentReplaceTarget.name;
            
            setStatus(`Updating references from ${targetName} to ${sourceImageName}...`);
            closeImageSelector();
            
            try {
                // Update code references in HTML/CSS/JS files
                const files = await fetchRootHtmlCssJsFiles();
                let updatedFiles = 0;
                
                for (let filename of files) {
                    let text = await fetchTextFile(filename);
                    if (!text) continue;
                    
                    let updated = updateCodeReferences(text, targetName, sourceImageName);
                    if (updated !== text) {
                        let fileSha = await fetchFileSha(filename);
                        const resp = await fetch(API_BASE + "/github/edit-file", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "x-admin-token": adminToken,
                                "x-username-token": usernameToken
                            },
                            body: JSON.stringify({
                                repo: GITHUB_REPOPATH,
                                path: filename,
                                content: updated,
                                message: `Update image references: ${targetName} → ${sourceImageName}`,
                                branch: "main",
                                sha: fileSha
                            })
                        });
                        
                        if (resp.ok) {
                            updatedFiles++;
                        }
                    }
                }
                
                if (updatedFiles > 0) {
                    setStatus(`Successfully updated ${updatedFiles} file(s) to use ${sourceImageName}!`);
                } else {
                    setStatus(`No references to ${targetName} found in code files.`, "error");
                }
                
                await fetchAndCategorizeImages();
                
            } catch (error) {
                console.error('Error updating image references:', error);
                setStatus(`Error updating image references: ${error.message}`, "error");
            }
        }

        function updateCodeReferences(code, oldImg, newImg) {
            // Update HTML src attributes
            code = code.replace(
                new RegExp(`(<[^>]+src=["'])images/${oldImg}(["'][^>]*>)`, "g"),
                `$1images/${newImg}$2`
            );
            // Update CSS url() references
            code = code.replace(
                new RegExp(`url\\(["']images/${oldImg}["']\\)`, "g"),
                `url('images/${newImg}')`
            );
            // Update any other plain text image references
            code = code.replace(
                new RegExp(`images/${oldImg}`, "g"),
                `images/${newImg}`
            );
            return code;
        }

        async function fetchFileSha(filename) {
            const url = `https://api.github.com/repos/${GITHUB_REPOPATH}/contents/${filename}`;
            const resp = await fetch(url, { headers: { Accept: "application/vnd.github+json" } });
            if (!resp.ok) return null;
            const meta = await resp.json();
            return meta && meta.sha ? meta.sha : null;
        }

        async function replaceImage(fname, sha) {
            const inp = document.getElementById("image-upload");
            inp.value = "";
            inp.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setStatus(`Uploading & relinking ${file.name}...`);
                const newFileName = getTimestampedFilename(file.name);
                const fr = new FileReader();
                fr.onload = async () => {
                    const b64 = fr.result.split(",")[1];
                    const uploadResp = await fetch(API_BASE + "/github/create-file", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "x-admin-token": adminToken,
                            "x-username-token": usernameToken
                        },
                        body: JSON.stringify({
                            repo: GITHUB_REPOPATH,
                            path: IMAGES_FOLDER + "/" + newFileName,
                            content: b64,
                            message: `Upload new image ${newFileName} (replace ${fname})`,
                            branch: "main"
                        }),
                        cache: "no-store"
                    });
                    if (!uploadResp.ok) {
                        setStatus("Error uploading image", "error");
                        return;
                    }

                    // Update code references to point to new image
                    const files = await fetchRootHtmlCssJsFiles();
                    for (let filename of files) {
                        let text = await fetchTextFile(filename);
                        if (!text) continue;
                        let updated = updateCodeReferences(text, fname, newFileName);
                        if (updated !== text) {
                            let fileSha = await fetchFileSha(filename);
                            await fetch(API_BASE + "/github/edit-file", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "x-admin-token": adminToken,
                                    "x-username-token": usernameToken
                                },
                                body: JSON.stringify({
                                    repo: GITHUB_REPOPATH,
                                    path: filename,
                                    content: updated,
                                    message: `Update ref to ${newFileName} replacing ${fname}`,
                                    branch: "main",
                                    sha: fileSha
                                }),
                                cache: "no-store"
                            });
                        }
                    }
                    setStatus("Image replaced & linked!", "success");
                    await fetchAndCategorizeImages();
                };
                fr.readAsDataURL(file);
            };
            inp.click();
        }

        function showImageUploader() {
            const inp = document.getElementById("image-upload");
            inp.value = "";
            inp.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setStatus(`Uploading ${file.name}...`);
                const fr = new FileReader();
                fr.onload = async () => {
                    const b64 = fr.result.split(",")[1];
                    const resp = await fetch(API_BASE + "/github/create-file", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "x-admin-token": adminToken,
                            "x-username-token": usernameToken
                        },
                        body: JSON.stringify({
                            repo: GITHUB_REPOPATH,
                            path: IMAGES_FOLDER + "/" + file.name,
                            content: b64,
                            message: `Add image ${file.name}`,
                            branch: "main"
                        }),
                        cache: "no-store"
                    });
                    if (resp.ok) {
                        setStatus("Image uploaded!");
                        await fetchAndCategorizeImages();
                    } else {
                        try {
                            const err = await resp.json();
                            setStatus(err.message || "Error uploading", "error");
                        } catch {
                            setStatus("Error uploading", "error");
                        }
                    }
                };
                fr.readAsDataURL(file);
            };
            inp.click();
        }

        async function deleteImage(fname, sha) {
            if (!confirm(`Delete ${fname}?`)) return;
            setStatus(`Deleting ${fname}...`);
            const resp = await fetch(API_BASE + "/github/delete-file", {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json",
                    "x-admin-token": adminToken,
                    "x-username-token": usernameToken
                },
                body: JSON.stringify({
                    repo: GITHUB_REPOPATH,
                    path: IMAGES_FOLDER + "/" + fname,
                    message: `Delete image ${fname}`,
                    branch: "main",
                    sha: sha
                })
            });
            if (resp.ok) {
                setStatus("Image deleted!");
                await fetchAndCategorizeImages();
            } else {
                setStatus("Error deleting image", "error");
            }
        }

        // ========== MENU MANAGEMENT ==========
        async function fetchMenu() {
            try {
                const resp = await fetch(API_BASE + "/menu");
                const menu = await resp.json();
                menuData = {};
                
                const tbody = document.getElementById("menu-table");
                tbody.innerHTML = "";
                
                for (const item of menu) {
                    menuData[item.id] = { ...item };
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${item.id}</td>
                        <td class="editable-cell" data-field="section" data-id="${item.id}" onclick="makeEditable(this)">${item.section}</td>
                        <td class="editable-cell" data-field="title" data-id="${item.id}" onclick="makeEditable(this)">${item.title}</td>
                        <td class="editable-cell" data-field="description" data-id="${item.id}" onclick="makeEditable(this, true)">${item.description}</td>
                        <td class="editable-cell" data-field="price" data-id="${item.id}" onclick="makeEditable(this)">${item.price}</td>
                        <td class="save-cell">
                            <button class="save-btn" id="save-btn-${item.id}" onclick="saveMenuItem(${item.id})">Save</button>
                        </td>
                        <td><button onclick="deleteMenuItem(${item.id})">Delete</button></td>
                    `;
                    tbody.appendChild(row);
                }
            } catch (error) {
                setStatus("Error loading menu", "error");
            }
        }

        function makeEditable(cell, isTextarea = false) {
            if (cell.querySelector('input') || cell.querySelector('textarea')) return;
            
            const id = cell.dataset.id;
            const field = cell.dataset.field;
            const currentValue = cell.textContent;
            
            let inputElement;
            if (isTextarea) {
                inputElement = document.createElement('textarea');
                inputElement.style.minHeight = '60px';
            } else {
                inputElement = document.createElement('input');
                inputElement.type = 'text';
            }
            
            inputElement.value = currentValue;
            inputElement.style.width = '100%';
            inputElement.style.border = '1px solid #FF8C00';
            inputElement.style.padding = '4px';
            inputElement.style.fontFamily = 'inherit';
            inputElement.style.fontSize = 'inherit';
            
            inputElement.addEventListener('blur', () => {
                const newValue = inputElement.value;
                cell.textContent = newValue;
                
                // Update local data
                if (menuData[id]) {
                    menuData[id][field] = newValue;
                    editedMenuItems.add(parseInt(id));
                }
            });
            
            inputElement.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !isTextarea) {
                    inputElement.blur();
                } else if (e.key === 'Escape') {
                    cell.textContent = currentValue;
                }
            });
            
            cell.innerHTML = '';
            cell.appendChild(inputElement);
            inputElement.focus();
            inputElement.select();
        }

        async function saveMenuItem(id) {
            if (!menuData[id] || !editedMenuItems.has(id)) {
                setStatus("No changes to save", "error");
                return;
            }
            
            const data = {
                section: menuData[id].section,
                title: menuData[id].title,
                description: menuData[id].description,
                price: menuData[id].price
            };

            try {
                const resp = await fetch(API_BASE + "/menu/" + id, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        "x-admin-token": adminToken,
                        "x-username-token": usernameToken
                    },
                    body: JSON.stringify(data)
                });

                if (resp.ok) {
                    setStatus("Menu item saved!");
                    editedMenuItems.delete(id);
                } else {
                    setStatus("Error saving menu item", "error");
                }
            } catch (error) {
                setStatus("Error saving menu item", "error");
            }
        }

        // Add form handler
        document.getElementById("add-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            const resp = await fetch(API_BASE + "/menu", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-admin-token": adminToken,
                    "x-username-token": usernameToken
                },
                body: JSON.stringify(data)
            });
            
            if (resp.ok) {
                setStatus("Menu item added!");
                e.target.reset();
                fetchMenu();
            } else {
                setStatus("Error adding menu item", "error");
            }
        });

        async function deleteMenuItem(id) {
            if (!confirm("Delete this menu item?")) return;
            
            const resp = await fetch(API_BASE + "/menu/" + id, {
                method: "DELETE",
                headers: {
                    "x-admin-token": adminToken,
                    "x-username-token": usernameToken
                }
            });
            
            if (resp.ok) {
                setStatus("Menu item deleted!");
                fetchMenu();
            } else {
                setStatus("Error deleting menu item", "error");
            }
        }

        // ========== CSS EDITOR LOGIC (UPDATED FOR PROXY) ==========
        const SIMPLE_CONTROLS = {
            'Basic Adjustments': {
                'Size': { property: 'width', min: 50, max: 800, unit: 'px', default: 300 },
                'Height': { property: 'height', min: 30, max: 600, unit: 'px', default: 200 },
                'Rounded Corners': { property: 'border-radius', min: 0, max: 50, unit: 'px', default: 0 },
                'Shadow': { property: 'box-shadow', min: 0, max: 30, unit: 'px', default: 0 },
                'Transparency': { property: 'opacity', min: 10, max: 100, unit: '%', default: 100 }
            },
            'Spacing': {
                'Space Around': { property: 'margin', min: 0, max: 100, unit: 'px', default: 0 },
                'Inner Padding': { property: 'padding', min: 0, max: 50, unit: 'px', default: 0 }
            }
        };

        function initializeEditor() {
            const frame = document.getElementById('previewFrame');
            
            // UPDATED: Load HTML via proxy to avoid CORS
            loadPreviewFromProxy();
            
            frame.addEventListener('load', setupClickableElements);
            
            setTimeout(() => {
                if (!isFrameReady) {
                    setupClickableElements();
                }
            }, 2000);
        }

 // NEW: Enhanced loadPreviewFromProxy function with image support
async function loadPreviewFromProxy() {
    try {
        // Fetch HTML content through proxy
        const htmlResponse = await fetch(`${API_BASE}/proxy/index.html`, {
            headers: {
                "x-admin-token": adminToken,
                "x-username-token": usernameToken
            }
        });
        
        if (!htmlResponse.ok) {
            throw new Error('Failed to load HTML via proxy');
        }
        
        let htmlContent = await htmlResponse.text();
        
        // Update HTML to use proxy endpoints for CSS and JS
        htmlContent = htmlContent.replace(
            /href="\.\/style\.css"/g,
            `href="${API_BASE}/proxy/style.css"`
        );
        htmlContent = htmlContent.replace(
            /src="\.\/script\.js"/g,
            `src="${API_BASE}/proxy/script.js"`
        );
        
        // Fix image paths in HTML to use GitHub raw URLs directly
        const GITHUB_RAW_BASE = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main`;
        htmlContent = htmlContent.replace(/src="images\//g, `src="${GITHUB_RAW_BASE}/images/`);
        htmlContent = htmlContent.replace(/src="\.\/images\//g, `src="${GITHUB_RAW_BASE}/images/`);
        
        // Also fetch and update CSS to fix background images
        const cssResponse = await fetch(`${API_BASE}/proxy/style.css`, {
            headers: {
                "x-admin-token": adminToken,
                "x-username-token": usernameToken
            }
        });
        
        if (cssResponse.ok) {
            let cssContent = await cssResponse.text();
            
            // Fix CSS background image paths to use GitHub raw URLs
            cssContent = cssContent.replace(
                /url\(['"]?images\//g,
                `url('${GITHUB_RAW_BASE}/images/`
            );
            cssContent = cssContent.replace(
                /url\(['"]?\.\/images\//g,
                `url('${GITHUB_RAW_BASE}/images/`
            );
            
            // Handle various CSS url() formats
            cssContent = cssContent.replace(
                /url\(['"]?\.\.\/images\//g,
                `url('${GITHUB_RAW_BASE}/images/`
            );
            cssContent = cssContent.replace(
                /url\(images\//g,
                `url(${GITHUB_RAW_BASE}/images/`
            );
            
            // Create inline style block with updated CSS
            const styleBlock = `<style>${cssContent}</style>`;
            
            // Remove original CSS link and add inline styles
            htmlContent = htmlContent.replace(
                /<link[^>]*href="[^"]*style\.css"[^>]*>/g,
                styleBlock
            );
        }
        
        // Create blob URL for the modified HTML
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const blobUrl = URL.createObjectURL(blob);
        
        const frame = document.getElementById('previewFrame');
        frame.src = blobUrl;
        
        // Clean up previous blob URL to prevent memory leaks
        if (frame.dataset.previousBlobUrl) {
            URL.revokeObjectURL(frame.dataset.previousBlobUrl);
        }
        frame.dataset.previousBlobUrl = blobUrl;
        
    } catch (error) {
        console.error('Error loading preview via proxy:', error);
        showError('Could not load website preview. Make sure your worker has proxy endpoints.');
    }
}


        function setupClickableElements() {
            const frame = document.getElementById('previewFrame');
            
            try {
                frameDocument = frame.contentDocument || frame.contentWindow?.document;
                frameWindow = frame.contentWindow;
                
                if (!frameDocument || !frameDocument.body) {
                    setTimeout(setupClickableElements, 500);
                    return;
                }
                
                injectStyles();
                
                const allElements = frameDocument.querySelectorAll('*');
                allElements.forEach((element, index) => {
                    const tagName = element.tagName.toLowerCase();
                    if (['html', 'head', 'body', 'script', 'style', 'meta', 'link', 'title'].includes(tagName)) {
                        return;
                    }
                    
                    element.setAttribute('data-editor-id', index);
                    element.addEventListener('click', (e) => handleElementClick(e, element));
                    element.addEventListener('mouseenter', (e) => handleElementHover(e, element));
                    element.addEventListener('mouseleave', (e) => handleElementUnhover(e, element));
                });
                
                isFrameReady = true;
                console.log('Editor initialized successfully');
                
            } catch (error) {
                console.error('Error initializing editor:', error);
                showError('Could not connect to your website. Make sure your worker has proxy endpoints.');
            }
        }

        function injectStyles() {
            if (!frameDocument) return;
            
            const styleElement = frameDocument.createElement('style');
            styleElement.id = 'editor-styles';
            styleElement.textContent = `
                .css-highlight {
                    outline: 3px solid #FF8C00 !important;
                    outline-offset: 3px !important;
                    background: rgba(255, 140, 0, 0.1) !important;
                    cursor: pointer !important;
                    transition: all 0.2s ease !important;
                }
                
                .css-selected {
                    outline: 3px solid #28a745 !important;
                    outline-offset: 3px !important;
                    background: rgba(40, 167, 69, 0.15) !important;
                }
                
                * {
                    transition: all 0.2s ease !important;
                }
            `;
            
            if (frameDocument.head) {
                frameDocument.head.appendChild(styleElement);
            }
        }

        function handleElementClick(event, element) {
            event.preventDefault();
            event.stopPropagation();
            
            clearSelection();
            selectedElement = element;
            currentEditingElement = element;
            element.classList.add('css-selected');
            
            if (!originalStyles.has(element)) {
                originalStyles.set(element, element.style.cssText);
            }
            
            updateSidebar(element);
            updateClickHint('🎯 Editing selected item - click another part to change selection');
        }

        function handleElementHover(event, element) {
            if (element === selectedElement) return;
            element.classList.add('css-highlight');
        }

        function handleElementUnhover(event, element) {
            if (element === selectedElement) return;
            element.classList.remove('css-highlight');
        }

        function clearSelection() {
            if (!frameDocument) return;
            
            frameDocument.querySelectorAll('.css-highlight, .css-selected').forEach(el => {
                el.classList.remove('css-highlight', 'css-selected');
            });
        }

        function determineCssSelector(element) {
            // Priority: ID > specific class > generic tag
            if (element.id) {
                return `#${element.id}`;
            }
            
            if (element.className) {
                const classes = element.className.split(' ').filter(c => c.trim() && !c.startsWith('css-'));
                if (classes.length > 0) {
                    return `.${classes[0]}`;
                }
            }
            
            // For nested elements like img inside other elements
            const parent = element.parentElement;
            if (parent && parent.className) {
                const parentClasses = parent.className.split(' ').filter(c => c.trim() && !c.startsWith('css-'));
                if (parentClasses.length > 0) {
                    return `.${parentClasses[0]} ${element.tagName.toLowerCase()}`;
                }
            }
            
            return element.tagName.toLowerCase();
        }

        function updateSidebar(element) {
            const elementType = getElementType(element);
            const elementName = getElementName(element);
            const cssSelector = determineCssSelector(element);
            
            const controlsArea = document.getElementById('controlsArea');
            
            let html = `
                <div class="element-info">
                    <div class="element-preview">
                        <div class="element-icon">${getElementIcon(element)}</div>
                        <div class="element-details">
                            <h3>${elementName}</h3>
                            <p>${elementType} element</p>
                            <div class="css-selector-info">CSS Selector: ${cssSelector}</div>
                        </div>
                    </div>
                </div>
                
                <div class="controls-container">
            `;
            
            // Add text editing button for text elements
            if (['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'span', 'a'].includes(element.tagName.toLowerCase())) {
                html += `<button class="edit-text-btn" onclick="openTextEditor()">✏️ Edit Text Content</button>`;
            }

            // Add image actions for images
            if (element.tagName.toLowerCase() === 'img') {
                html += `
                    <div class="image-actions">
                        <button class="upload-btn" onclick="uploadImageForElement()">📁 Upload New</button>
                        <button class="replace-btn" onclick="replaceImageForElementViaFile()">🔄 Replace</button>
                        <button class="replace-existing-btn" onclick="replaceImageForElementWithExisting()">🔀 Replace w/ Existing</button>
                    </div>
                `;
            }
            
            Object.entries(SIMPLE_CONTROLS).forEach(([groupName, controls]) => {
                html += `
                    <div class="control-group">
                        <h4>${groupName}</h4>
                `;
                
                Object.entries(controls).forEach(([controlName, config]) => {
                    const currentValue = getCurrentValue(element, config);
                    const controlId = `control-${config.property}`;
                    
                    html += `
                        <div class="control-item">
                            <div class="control-label">
                                <span>${controlName}</span>
                                <span class="control-value" id="value-${controlId}">${formatValue(currentValue, config.unit)}</span>
                            </div>
                            <input 
                                type="range" 
                                class="control-slider"
                                id="${controlId}"
                                min="${config.min}"
                                max="${config.max}"
                                value="${currentValue}"
                                data-property="${config.property}"
                                data-unit="${config.unit}"
                                oninput="handleSliderChange(this)"
                            >
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            html += `
                    <button class="save-changes-btn" onclick="saveStyleChanges()">💾 Save Changes</button>
                </div>
            `;
            
            controlsArea.innerHTML = html;
        }

        function getElementType(element) {
            const tagName = element.tagName.toLowerCase();
            
            if (tagName === 'img') return 'Image';
            if (tagName === 'button' || tagName === 'input') return 'Button';
            if (['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'span', 'a'].includes(tagName)) return 'Text';
            if (['div', 'section', 'article', 'header', 'footer'].includes(tagName)) return 'Section';
            
            return 'Element';
        }

        function getElementName(element) {
            if (element.alt) return element.alt;
            if (element.title) return element.title;
            if (element.textContent && element.textContent.trim()) {
                return element.textContent.trim().substring(0, 30) + (element.textContent.trim().length > 30 ? '...' : '');
            }
            if (element.className) return `${element.tagName.toLowerCase()}.${element.className.split(' ')[0]}`;
            if (element.id) return `${element.tagName.toLowerCase()}#${element.id}`;
            
            return element.tagName.toLowerCase();
        }

        function getElementIcon(element) {
            const tagName = element.tagName.toLowerCase();
            
            if (tagName === 'img') return '🖼️';
            if (tagName === 'button' || tagName === 'input') return '🔘';
            if (['h1', 'h2', 'h3', 'h4', 'h5', 'h6'].includes(tagName)) return '📰';
            if (['p', 'span', 'a'].includes(tagName)) return '📝';
            if (['div', 'section', 'article'].includes(tagName)) return '📦';
            if (tagName === 'header') return '🏠';
            if (tagName === 'footer') return '🔚';
            
            return '⭐';
        }

        function getCurrentValue(element, config) {
            if (!frameWindow) return config.default;
            
            try {
                const computedStyle = frameWindow.getComputedStyle(element);
                
                switch (config.property) {
                    case 'width':
                        const width = parseFloat(computedStyle.width) || config.default;
                        return Math.min(Math.max(width, config.min), config.max);
                        
                    case 'height':
                        const height = computedStyle.height;
                        if (height === 'auto') return config.default;
                        const heightValue = parseFloat(height) || config.default;
                        return Math.min(Math.max(heightValue, config.min), config.max);
                        
                    case 'border-radius':
                        const borderRadius = parseFloat(computedStyle.borderRadius) || config.default;
                        return Math.min(Math.max(borderRadius, config.min), config.max);
                        
                    case 'box-shadow':
                        const boxShadow = computedStyle.boxShadow;
                        if (!boxShadow || boxShadow === 'none') return 0;
                        const match = boxShadow.match(/(\d+)px/g);
                        if (match && match.length >= 3) {
                            return Math.min(Math.max(parseInt(match[2]), config.min), config.max);
                        }
                        return 0;
                        
                    case 'opacity':
                        const opacity = parseFloat(computedStyle.opacity) || 1;
                        return Math.round(opacity * 100);
                        
                    case 'margin':
                        const margin = parseFloat(computedStyle.margin) || config.default;
                        return Math.min(Math.max(margin, config.min), config.max);
                        
                    case 'padding':
                        const padding = parseFloat(computedStyle.padding) || config.default;
                        return Math.min(Math.max(padding, config.min), config.max);
                        
                    default:
                        return config.default;
                }
            } catch (error) {
                console.error('Error getting current value:', error);
                return config.default;
            }
        }

        function formatValue(value, unit) {
            if (unit === '%') {
                return Math.round(value) + '%';
            }
            return Math.round(value) + unit;
        }

        function handleSliderChange(slider) {
            if (!selectedElement) return;
            
            const property = slider.dataset.property;
            const unit = slider.dataset.unit;
            const value = parseFloat(slider.value);
            
            const valueDisplay = document.getElementById(`value-control-${property}`);
            if (valueDisplay) {
                valueDisplay.textContent = formatValue(value, unit);
            }
            
            applyStyle(selectedElement, property, value, unit);
            
            // Store pending changes
            if (!pendingChanges[selectedElement.tagName]) {
                pendingChanges[selectedElement.tagName] = {};
            }
            pendingChanges[selectedElement.tagName][property] = { value, unit };
        }

        function applyStyle(element, property, value, unit) {
            try {
                switch (property) {
                    case 'width':
                        element.style.width = value + 'px';
                        break;
                        
                    case 'height':
                        element.style.height = value + 'px';
                        break;
                        
                    case 'border-radius':
                        element.style.borderRadius = value + 'px';
                        break;
                        
                    case 'box-shadow':
                        if (value > 0) {
                            element.style.boxShadow = `0 2px ${value}px rgba(0, 0, 0, 0.2)`;
                        } else {
                            element.style.boxShadow = 'none';
                        }
                        break;
                        
                    case 'opacity':
                        element.style.opacity = value / 100;
                        break;
                        
                    case 'margin':
                        element.style.margin = value + 'px';
                        break;
                        
                    case 'padding':
                        element.style.padding = value + 'px';
                        break;
                }
            } catch (error) {
                console.error('Error applying style:', error);
            }
        }

        async function saveStyleChanges() {
            if (!selectedElement || !currentEditingElement) {
                alert('No element selected to save changes for.');
                return;
            }

            const appliedStyles = selectedElement.style.cssText;
            if (!appliedStyles) {
                alert('No changes to save.');
                return;
            }

            try {
                // Load current CSS content via proxy if not already loaded
                if (!cssContent) {
                    const resp = await fetch(`${API_BASE}/proxy/style.css`, {
                        headers: {
                            "x-admin-token": adminToken,
                            "x-username-token": usernameToken
                        }
                    });
                    if (resp.ok) {
                        cssContent = await resp.text();
                    }
                }

                const cssSelector = determineCssSelector(selectedElement);
                let updatedCSS = cssContent;

                // Parse applied styles
                const styleRules = {};
                appliedStyles.split(';').forEach(rule => {
                    const [prop, val] = rule.split(':').map(s => s.trim());
                    if (prop && val) {
                        styleRules[prop] = val;
                    }
                });

                // Find existing CSS rule or create new one
                const selectorPattern = new RegExp(`(${cssSelector.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\s*\\{[^}]*\\})`, 'g');
                const match = selectorPattern.exec(updatedCSS);

                if (match) {
                    // Update existing rule
                    let existingRule = match[1];
                    let ruleContent = existingRule.substring(existingRule.indexOf('{') + 1, existingRule.lastIndexOf('}'));
                    
                    // Parse existing properties
                    const existingProps = {};
                    ruleContent.split(';').forEach(line => {
                        const [prop, val] = line.split(':').map(s => s.trim());
                        if (prop && val) {
                            existingProps[prop] = val;
                        }
                    });

                    // Merge with new properties
                    Object.assign(existingProps, styleRules);

                    // Rebuild rule
                    const newRuleContent = Object.entries(existingProps)
                        .map(([prop, val]) => `    ${prop}: ${val};`)
                        .join('\n');
                    
                    const newRule = `${cssSelector} {\n${newRuleContent}\n}`;
                    updatedCSS = updatedCSS.replace(existingRule, newRule);
                } else {
                    // Create new rule
                    const newRuleContent = Object.entries(styleRules)
                        .map(([prop, val]) => `    ${prop}: ${val};`)
                        .join('\n');
                    
                    const newRule = `\n${cssSelector} {\n${newRuleContent}\n}`;
                    updatedCSS += newRule;
                }

                // Save updated CSS
                const fileSha = await fetchFileSha('style.css');
                const resp = await fetch(API_BASE + "/github/edit-file", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-admin-token": adminToken,
                        "x-username-token": usernameToken
                    },
                    body: JSON.stringify({
                        repo: GITHUB_REPOPATH,
                        path: 'style.css',
                        content: updatedCSS,
                        message: `Update CSS styles for ${cssSelector} via live editor`,
                        branch: "main",
                        sha: fileSha
                    })
                });

                if (resp.ok) {
                    cssContent = updatedCSS; // Update local cache
                    alert('✅ Styles saved successfully! Changes will appear on your live site.');
                    pendingChanges = {};
                } else {
                    const error = await resp.json();
                    alert('❌ Error saving styles: ' + (error.message || 'Unknown error'));
                }

            } catch (error) {
                console.error('Error saving styles:', error);
                alert('❌ Error saving styles: ' + error.message);
            }
        }

        // ========== TEXT EDITING ==========
        function openTextEditor() {
            if (!selectedElement) return;
            
            const modal = document.getElementById('textEditorModal');
            const textarea = document.getElementById('textEditorTextarea');
            
            textarea.value = selectedElement.textContent || selectedElement.innerText || '';
            modal.style.display = 'flex';
        }

        function closeTextEditor() {
            document.getElementById('textEditorModal').style.display = 'none';
        }

        async function saveTextEdit() {
            const newText = document.getElementById('textEditorTextarea').value;
            if (!selectedElement) return;

            try {
                const originalText = selectedElement.textContent;
                
                // Update the element temporarily
                selectedElement.textContent = newText;
                
                // Find the HTML file and update it via proxy
                const htmlResponse = await fetch(`${API_BASE}/proxy/index.html`, {
                    headers: {
                        "x-admin-token": adminToken,
                        "x-username-token": usernameToken
                    }
                });
                
                if (!htmlResponse.ok) {
                    throw new Error('Could not load HTML via proxy');
                }
                
                const htmlContent = await htmlResponse.text();
                
                if (htmlContent.includes(originalText)) {
                    const updatedHTML = htmlContent.replace(originalText, newText);
                    
                    const fileSha = await fetchFileSha('index.html');
                    const resp = await fetch(API_BASE + "/github/edit-file", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "x-admin-token": adminToken,
                            "x-username-token": usernameToken
                        },
                        body: JSON.stringify({
                            repo: GITHUB_REPOPATH,
                            path: 'index.html',
                            content: updatedHTML,
                            message: `Update text content via live editor`,
                            branch: "main",
                            sha: fileSha
                        })
                    });

                    if (resp.ok) {
                        alert('✅ Text updated successfully!');
                        closeTextEditor();
                    } else {
                        const error = await resp.json();
                        alert('❌ Error saving text: ' + (error.message || 'Unknown error'));
                    }
                } else {
                    alert('⚠️ Could not locate exact text in HTML file. Text may contain special formatting.');
                }

            } catch (error) {
                console.error('Error saving text:', error);
                alert('❌ Error saving text: ' + error.message);
            }
        }

        // ========== IMAGE HANDLING IN CSS EDITOR ==========
        function uploadImageForElement() {
            showImageUploader();
        }

        function replaceImageForElementViaFile() {
            if (!selectedElement || selectedElement.tagName.toLowerCase() !== 'img') return;
            
            const imgSrc = selectedElement.src;
            const imgName = imgSrc.split('/').pop();
            
            // Find the image in our list and replace it via file upload
            replaceImage(imgName, ''); // SHA will be found automatically
        }

        function replaceImageForElementWithExisting() {
            if (!selectedElement || selectedElement.tagName.toLowerCase() !== 'img') return;
            
            const imgSrc = selectedElement.src;
            const imgName = imgSrc.split('/').pop();
            
            // Find the image in our list and show the existing image selector
            const targetImage = allImages.find(img => img.name === imgName);
            if (targetImage) {
                showReplaceWithExisting(targetImage.name, targetImage.sha);
            } else {
                alert('Could not find image in database. Please refresh and try again.');
            }
        }

        function resetAllStyles() {
            if (!frameDocument) return;
            
            originalStyles.forEach((originalStyle, element) => {
                try {
                    element.style.cssText = originalStyle;
                } catch (error) {
                    console.error('Error resetting element style:', error);
                }
            });
            
            clearSelection();
            selectedElement = null;
            currentEditingElement = null;
            pendingChanges = {};
            
            const controlsArea = document.getElementById('controlsArea');
            controlsArea.innerHTML = `
                <div class="welcome-message">
                    <div class="icon">🖱️</div>
                    <h3>Ready to customize!</h3>
                    <p>Click on any image, text, button, or section in your website preview to start editing its appearance.</p>
                </div>
            `;
            
            updateClickHint('👆 Click anything in the preview to start editing');
        }

        function updateClickHint(message) {
            const clickHint = document.getElementById('clickHint');
            if (clickHint) {
                clickHint.textContent = message;
            }
        }

        function showError(message) {
            const controlsArea = document.getElementById('controlsArea');
            controlsArea.innerHTML = `
                <div class="welcome-message">
                    <div class="icon">⚠️</div>
                    <h3>Connection Error</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        console.log('Advanced CMS Dashboard with CORS proxy support loaded successfully');
    </script>
</body>
</html>
